# 4장 카프카의 내부 동작 원리와 구현

## 카프카 리플리케이션

 - 리더는 리플리케이션중 하나가 선정되며 모든 읽기와 쓰기는 리더에 의해서 동작한다.
 - 팔로워는 리더가 push가 아닌 팔로워가 pull방식으로 데이터를 가져온다.
 - 리더에 문제가 발생할경우 팔로워가 리더로 승격하여 동작한다.
![img_2.png](img_2.png)
 
 - 복제유지와 커밋
   - 리더와 팔로워는 ISR이라는 그룹으로 묶여있다.
   - ISR그룹안에 속해있는 팔로워만이 리더에 문제가 생겼을경우 리더가 될 자격이 있다.
   - 오류, 장애 등 이유로 팔로워가 리플리케이션을 따라가지 못하는경우 ISR그룹에서 팔로워는 추방당한다.
   
 - 리더와 팔로워의 단계별 리플리케이션 동작
   - 카프카는 리더와 팔로워 사이에 ACK통신을 제거함으로써 리플리케이션 성능을 높임.
 
 - 컨트롤러
   - 컨트롤러는 리더 선출하는 역할을 한다. 
   - 리더를 선출하기위한 정보는 ISR리스트라고 하며 가용성보장을위해 주키퍼에 저장되어있음.
   - 브로커를 계속 모니터링하고 있으며, 장애 발생시 즉시 ISR에 리스트중 하나를 새로운 리더로 선출한다.
   
 - 로그(로그 세그먼트)
   - 카프카 토픽에 메세지는 세그먼트라는 로그파일에 순차적으로 저장.
   - 로그 세그먼트를 관리하는 방법은 세그먼트 삭제와 컴팩션으로 나뉜ㅏ.
 
 - 로그 세그먼트 삭제
   - 일정 주기를 주어서 그 주기만큼 로그 세그먼트를 저장후 삭제한다.
   - retention.bytes옵션을 사용하면 일정크기를 기준으로 삭제할수 있다.
   

 - 세그먼트 컴팩션
   - 로그를 삭제 하지 않고 보관하여 관리하는 정책
   - 현재 활성화된 세그먼트를 제외하고 마지막 세그먼트를 대상으로 관리한다.
   - 키값을 기준으로 가장 마지막 값이 필요한 경우 사용.
   - 


