# 카프카 정리 6장. 컨슈머 내부 동작

### 컨슈머 오프셋 관리

- 컨슈머의 가장 핵심은 오프셋 관리이다. 오프셋은 카프카에서 메시지의 위치를 나타내는 위치를 오프셋이라한다.
   - 장애가 발생하여 기존 컨슈머대신 새로운 컨슈머가 기존 컨슈머 역할을 대신할경우 기존 컨슈머의 장애발생 메시지 위치부터 가져와야 장애로부터 대응이 빠르다.
   - 오프셋 정보를 __consumer_offsets토픽에 그룹별로 오프셋 정보를 기록.


### __consumer_offsets
- 파티션수와 리플리케이션 팩터수를 가지고 있으며 설정값을 통해 원하는 값으로 변경가능

```
offsets.topic.num.partitions : 기본값 50
offsets.topic.replication.factor : 기본값 3
```

___
### 그룹 코디네이터
- 컨슈머는 하나의 컨슈머 그룹 구성원에 속하며, 그룹내의 컨슈머들은 서로 정보를 공유하며 하나의 공동체로 동작하는 특징이있다.
   - 그룹 내 컨슈머는 그룹에서 떠날수도있고 새롭게 추가될수도 있다.
   - 컨슈머들은 각 작업을 균등하게 분배해야하는데 이러한 동작을 리밸런싱이라한다.

- 컨슈머에도 그룹관리를 위해 코디네이터가 존재, 이를 그룹 코디네이터라 한다.
   - 그룹코디네이터의 목적은 토픽의 파티션, 멤버를 트래킹 하는것이다.
   - 그룹에 컨슈머에 대한 변화가 생기면 작업을 균등하게 재분배하기위해서 컨슈머 리밸런이 발생한다.
   - 그룹 코디네이터는 컨슈머 그룹별로 존재하며 위치는 카프카 클러스터 브로커중 하나에 위치한다.
  
---
### 스태틱 멤버쉽

- 점검이나 업데이트 같은 이유로 컨슈머가 재시작되는경우 하트비트(헬스체크)주기, 세션 타임아웃들의 설정으로 컨슈머가재시작 될때 마다 전체 리밸런싱이 일어나면 번거롭다.

- 리밸런싱이 일어나는 이유는 컨슈머 동작그룹에서 엔티티ID가 부여되는데 컨슈머가 재시작시 새로운 컨슈머로 인식해 새로운 엔티티ID가 부여되고 그로인해 전체 리밸런싱이 발생한다.

- 스태틱 멤버쉽이란 컨슈머 그룹에서 재시작등으로 그룹에서 나갔다가 다시 들어왔을때에도 리밸런싱이 일어나지 않게 한다.

---
### 컨슈머 파티션 할당 전략


| 파티션 할당 전략        | 설명                                                                  |
|------------------|---------------------------------------------------------------------|
| 레인지 파티션 할당 전력    | 파티션 할당 전략의 기본값으로서 토픽별로 할당 전략을 사용함. 동일한 키를 이용하는 2개 이상의 토픽을 컨슘할 떄 유용함 |
| 라운드 로빈 파티션 할당 전략 | 사용가능한 파티션과 컨슈머들을 라운드 로빈으로 할당함 , 균등한 분배가능                            |
| 스티키 파티션 할당 전력    | 컨슈머가 컨슘하고 있는 파티션을 계속 유지할수 있음.                                       |
| 협력적 스티키 할당 전력    | 스티키 방식과 유사하지만, 전체 일시정지가 아닌 연속적인 재조정 방식.                             |
