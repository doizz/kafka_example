# 카프카 버전 업그레이드와 확장

---
### 카프카 버전 업그레이드를 위한 준비
- 초기의 사용률을 고려하여 카프카를 구성하게되지만 예외상황을 맞이한다면 카프카를 확장해야될 경우가 생깁니다.
- 카프카는 이렇게 확장해야될 경우를 고려해 손쉽게 확장될수있도록 디자인되어있습니다.
- kafka-scaleout.yml명령어를 실행하여 카프카 서버를 추가한다.

---
### 주키퍼 의존성이 있는 카프카 롤링 업그레이드

---
### 카프카의 확장

- 카프카 서버를 추가해도 기존에 다른 브로커가 가지고있는 토픽들은 분산이 되지않고 서버 추가후 이후에 들어온 토픽이 증설한 카프카 서버를 포함하여 고르게 분배된다. 
- 이러한 문제는 브로커의 부하 분산을 통하여 기존에 사용률이 높았던 카프카의 토픽을 고르게 분산시켜줘야한다.

  - 브로커의 부하 분산
  - kafka-reassign-partitions.sh도구를 이용하여 파티션을 이동시킬수 있다.
  먼저 분산시킬 대상토픽을 정한다음 토픽을 어느 브로커로 분산시킬지 결정한다.
  분산시킬 대상 토픽에 대한 JSON파일을 생성후  kafka-reassign-partitions.sh명령어를 이용해 분산시킬 브로커 리스트 지정.


- 관리자 입장에서는 카프카 클러스터에 브로커를 추가하면 카프카의 로드가 자동으로 분산되리라 기대하지만, 실제로는 기존 브로커가 갖고있던 파티션들은 자동으로 분산되지 않는다. 신규 브로커가 추가된이후에 생성된 토픽은 신규 브로커를 포함해 고르게 분산배치가된다.
기존 파티션들이 모든 브로커에 고르게 분산되도록 수동으로 분산작업을 진행하여 분산배치가 될수있도록 한다.


- 분산배치 작업시 주의사항
   - 버전 업그레이드와 마찬가지로 카프카의 사용량이 낮은 시간대에 진행하는것을 추천.

